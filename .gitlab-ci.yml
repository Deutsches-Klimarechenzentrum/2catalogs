# ============================================================================
# GitLab CI/CD Configuration - Catalog Generation (Forge) Pipeline
# ============================================================================
# 
# This pipeline is responsible for:
# - Catalog generation (Forge) triggered by GitHub issues
# - GitLab Pages deployment with Sphinx-built documentation
# - Manual forge jobs
#
# Testing and building are handled by GitHub Actions
# All jobs use Docker with UV for fast, cached dependency management
#
# ============================================================================

# Workflow configuration
workflow:
  rules:
    # Run pipeline for commits to main branch (for Pages deployment)
    - if: $CI_COMMIT_BRANCH == "main"
    # Allow manual pipeline runs (for forge jobs)
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run for trigger events (GitHub webhook integration)
    - if: $CI_PIPELINE_SOURCE == "trigger"
    # Run for pipeline events (GitHub webhook integration)
    - if: $CI_PIPELINE_SOURCE == "pipeline"

# Define stages for the pipeline
stages:
  - setup
  - forge
  - deploy

# Global variables
variables:
  # UV and Python configuration
  UV_VERSION: "0.5"
  PYTHON_VERSION: "3.12"
  BASE_LAYER: bookworm-slim
  UV_LINK_MODE: copy  # GitLab CI needs copy mode for separate mountpoints
  
  # Cache directories
  UV_CACHE_DIR: .uv-cache
  UV_INSTALL_DIR: .local/bin
  
  # Deployment settings
  PAGES_BRANCH: "main"
    
  # Debian
  DEBIAN_FRONTEND: noninteractive
  
  # GitHub integration (these are set by GitHub webhook)
  GITHUB_ISSUE_NUMBER: ""
  GITHUB_ISSUE_TITLE: ""
  GITHUB_ISSUE_BODY: ""
  GITHUB_ISSUE_LABELS: ""

# ============================================================================
# TEMPLATES
# ============================================================================

.defaults:
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags:
    - docker-any-image
  extends: [".cache"]

.cache:
  cache:
    key:
      files:
        - uv.lock
    paths:
      - $UV_CACHE_DIR
      - $UV_INSTALL_DIR

# ============================================================================
# SETUP STAGE - Dependency Installation
# ============================================================================

uv:setup:
  extends: .defaults
  stage: setup
  script:
    - uv sync --all-extras
    - uv cache prune --ci

# ============================================================================
# FORGE STAGE - Catalog Generation with Docker + UV
# ============================================================================
 or from GitHub
    ISSUE_NUMBER: "${GITHUB_ISSUE_NUMBER:-${CI_JOB_ID}}"
    CATALOG_TYPE: "intake"  # or "stac" or "all"
  script:
    - uv sync --all-extras
    - |
      # Use GitHub issue body if available, otherwise require ISSUE_BODY variable
      if [ -n "$GITHUB_ISSUE_BODY" ]; then
        export ISSUE_BODY="$GITHUB_ISSUE_BODY"
      fi
      if [ -z "$ISSUE_BODY" ]; then
        echo "❌ Error: ISSUE_BODY variable is required"
        echo "Please provide the catalog specification in ISSUE_BODY variable"
        echo "Or trigger from GitHub issues
  script:
    - uv sync --all-extras
    - |
      if [ -z "$ISSUE_BODY" ]; then
        echo "❌ Error: ISSUE_BODY variable is required"
        echo "Please provide the catalog specification in ISSUE_BODY variable"
        exit 1
      fi
    - uv run python .gitlab/scripts/forge_parser.py
    - |
      if [ -d "forge_output" ]; then
        echo "✓ Forge output created successfully"
        ls -lah forge_output/
        if [ -f "forge_output/info.txt" ]; then
          cat forge_output/info.txt
        fi
        if [ -f "forge_output/error.log" ]; then
          echo "⚠️  Errors occurred:"
          cat forge_output/error.log
        fi
      fi
  artifacts:
    paths:
      - forge_output/
      - catalog/
    expire_in: 5 days
  when: manual
  allow_failure: true

forge:intake:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "intake"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: manual

forge:stac:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "stac"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: manual

forge:all:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "all"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: manual


forge:create-merge-request:
  extends: .defaults
  stage: forge
  needs:
    - job: uv:setup
    - job: forge:intake
      optional: true
    - job: forge:stac
      optional: true
    - job: forge:all
      optional: true
  before_script:
    # Install git and requests for MR creation
    - apt-get update && apt-get install -y git
    - uv pip install requests
  script:
    - |
      # Run the merge request creation script
      uv run python .gitlab/scripts/create_merge_request.py
  artifacts:
    paths:
      - forge_output/
    expire_in: $ARTIFACT_RETENTION
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: on_success
  # Requires CI_PUSH_TOKEN and GITHUB_TOKEN variables with write access

# ============================================================================
# DEPLOY STAGE - GitLab Pages with Sphinx
# ============================================================================

pages:
  extends: .defaults
  stage: deploy
  needs: ["uv:setup"]
  before_script:
    # Install Sphinx dependencies
    - uv sync --group docs
  script:
    # Build documentation with Sphinx
    - uv run sphinx-build -b html docs public
    
    # Copy catalog directory (generated by forge jobs)
    - cp -r catalog public/ || echo "No catalog directory found yet"
    
    - echo "✓ Deployed to GitLab Pages with Sphinx-builtalog directory found yet"
    
    # Copy README to public root
    - cp README.md public/ || echo "No README.md found"
    
    - echo "✓ Deployed to GitLab Pages with documentation"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == $PAGES_BRANCH'
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab-pages.dkrz.de/-/$CI_PROJECT_NAME/
  # For GitLab Pages, artifacts must be in 'public' directory
