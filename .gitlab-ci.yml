# ============================================================================
# GitLab CI/CD Configuration - Catalog Generation (Forge) Pipeline
# ============================================================================
# 
# This pipeline is responsible for:
# - Catalog generation (Forge) from GitLab issues
# - GitLab Pages deployment
# - Manual forge jobs
#
# Testing and building are handled by GitHub Actions
# All jobs use Docker with UV for fast, cached dependency management
#
# ============================================================================

# Workflow configuration
workflow:
  rules:
    # Run pipeline for commits to main branch (for Pages deployment)
    - if: $CI_COMMIT_BRANCH == "main"
    # Allow manual pipeline runs (for forge jobs)
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run for issue events (GitLab webhook integration)
    - if: $CI_PIPELINE_SOURCE == "trigger"

# Define stages for the pipeline
stages:
  - setup
  - forge
  - deploy

# Global variables
variables:
  # UV and Python configuration
  UV_VERSION: "0.5"
  PYTHON_VERSION: "3.12"
  BASE_LAYER: bookworm-slim
  UV_LINK_MODE: copy  # GitLab CI needs copy mode for separate mountpoints
  
  # Cache directories
  UV_CACHE_DIR: .uv-cache
  UV_INSTALL_DIR: .local/bin
  
  # Deployment settings
  PAGES_BRANCH: "main"
    
  # Debian
  DEBIAN_FRONTEND: noninteractive

# ============================================================================
# TEMPLATES
# ============================================================================

.defaults:
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags:
    - docker-any-image
  extends: [".cache"]

.cache:
  cache:
    key:
      files:
        - uv.lock
    paths:
      - $UV_CACHE_DIR
      - $UV_INSTALL_DIR

# ============================================================================
# SETUP STAGE - Dependency Installation
# ============================================================================

uv:setup:
  extends: .defaults
  stage: setup
  script:
    - uv sync --all-extras
    - uv cache prune --ci

# ============================================================================
# FORGE STAGE - Catalog Generation with Docker + UV
# ============================================================================

.forge_template:
  extends: .defaults
  stage: forge
  needs: ["uv:setup"]
  variables:
    # Override these when triggering manually
    ISSUE_NUMBER: "${CI_JOB_ID}"
    CATALOG_TYPE: "intake"  # or "stac" or "all"
  script:
    - uv sync --all-extras
    - |
      if [ -z "$ISSUE_BODY" ]; then
        echo "‚ùå Error: ISSUE_BODY variable is required"
        echo "Please provide the catalog specification in ISSUE_BODY variable"
        exit 1
      fi
    - uv run python .gitlab/scripts/forge_parser.py
    - |
      if [ -d "forge_output" ]; then
        echo "‚úì Forge output created successfully"
        ls -lah forge_output/
        if [ -f "forge_output/info.txt" ]; then
          cat forge_output/info.txt
        fi
        if [ -f "forge_output/error.log" ]; then
          echo "‚ö†Ô∏è  Errors occurred:"
          cat forge_output/error.log
        fi
      fi
  artifacts:
    paths:
      - forge_output/
      - catalog/
    expire_in: 5 days
  when: manual
  allow_failure: true

forge:intake:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "intake"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual

forge:stac:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "stac"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual

forge:all:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "all"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual


forge:auto-commit:
  extends: .defaults
  stage: forge
  needs:
    - job: uv:setup
    - job: forge:intake
      optional: true
    - job: forge:stac
      optional: true
    - job: forge:all
      optional: true
  before_script:
    # Install git for auto-commit
    - apt-get update && apt-get install -y git
  script:
    - |
      if [ -f "forge_output/added_to_main.txt" ]; then
        echo "üìù Catalog was added to main catalog, committing changes..."
        git config user.name "gitlab-ci"
        git config user.email "gitlab-ci@${CI_PROJECT_NAMESPACE}.gitlab.com"
        git remote set-url origin https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
        git add catalog/main.yaml
        git commit -m "Add catalog from forge job ${CI_JOB_ID} [skip ci]" || echo "No changes to commit"
        git push origin HEAD:${CI_COMMIT_REF_NAME} || echo "Push failed, but continuing..."
      else
        echo "‚ÑπÔ∏è  No catalog updates to commit"
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"'
      when: on_success
  # Requires CI_PUSH_TOKEN variable with write access

# ============================================================================
# DEPLOY STAGE - GitLab Pages
# ============================================================================

pages:
  extends: .defaults
  stage: deploy
  needs: ["uv:setup"]
  script:
    # Copy entire docs directory to public (contains all pages content)
    - cp -r docs public
    
    # Copy catalog directory (generated by forge jobs)
    - cp -r catalog public/ || echo "No catalog directory found yet"
    
    # Copy README to public root
    - cp README.md public/ || echo "No README.md found"
    
    - echo "‚úì Deployed to GitLab Pages with documentation"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == $PAGES_BRANCH'
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab-pages.dkrz.de/-/$CI_PROJECT_NAME/
  # For GitLab Pages, artifacts must be in 'public' directory
