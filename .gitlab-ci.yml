# ============================================================================
# GitLab CI/CD Configuration - Catalog Generation (Forge) Pipeline
# ============================================================================
# 
# This pipeline is responsible for:
# - Catalog generation (Forge) from GitLab issues
# - GitLab Pages deployment
# - Manual forge jobs
#
# Testing and building are handled by GitHub Actions
# All jobs use Docker with UV for fast, cached dependency management
#
# ============================================================================

# Workflow configuration
workflow:
  rules:
    # Run pipeline for commits to main branch (for Pages deployment)
    - if: $CI_COMMIT_BRANCH == "main"
    # Allow manual pipeline runs (for forge jobs)
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run for issue events (GitLab webhook integration)
    - if: $CI_PIPELINE_SOURCE == "trigger"

# Define stages for the pipeline
stages:
  - setup
  - forge
  - deploy

# Global variables
variables:
  # UV and Python configuration
  UV_VERSION: "0.5"
  PYTHON_VERSION: "3.12"
  BASE_LAYER: bookworm-slim
  UV_LINK_MODE: copy  # GitLab CI needs copy mode for separate mountpoints
  
  # Cache directories
  UV_CACHE_DIR: .uv-cache
  UV_INSTALL_DIR: .local/bin
  
  # Deployment settings
  PAGES_BRANCH: "main"
  
  # Artifact retention
  ARTIFACT_RETENTION: "5 days"
  
  # Debian
  DEBIAN_FRONTEND: noninteractive

# ============================================================================
# TEMPLATES
# ============================================================================

.defaults:
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags:
    - docker-any-image
  extends: [".cache"]

.cache:
  cache:
    key:
      files:
        - uv.lock
    paths:
      - $UV_CACHE_DIR
      - $UV_INSTALL_DIR

# ============================================================================
# SETUP STAGE - Dependency Installation
# ============================================================================

uv:setup:
  extends: .defaults
  stage: setup
  script:
    - uv sync --all-extras
    - uv cache prune --ci

# ============================================================================
# FORGE STAGE - Catalog Generation with Docker + UV
# ============================================================================

.forge_template:
  extends: .defaults
  stage: forge
  needs: ["uv:setup"]
  variables:
    # Override these when triggering manually
    ISSUE_NUMBER: "${CI_JOB_ID}"
    CATALOG_TYPE: "intake"  # or "stac" or "all"
  script:
    - uv sync --all-extras
    - |
      if [ -z "$ISSUE_BODY" ]; then
        echo "‚ùå Error: ISSUE_BODY variable is required"
        echo "Please provide the catalog specification in ISSUE_BODY variable"
        exit 1
      fi
    - uv run python .gitlab/scripts/forge_parser.py
    - |
      if [ -d "forge_output" ]; then
        echo "‚úì Forge output created successfully"
        ls -lah forge_output/
        if [ -f "forge_output/info.txt" ]; then
          cat forge_output/info.txt
        fi
        if [ -f "forge_output/error.log" ]; then
          echo "‚ö†Ô∏è  Errors occurred:"
          cat forge_output/error.log
        fi
      fi
  artifacts:
    paths:
      - forge_output/
      - catalog/
    expire_in: $ARTIFACT_RETENTION
  when: manual
  allow_failure: true

forge:intake:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "intake"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual

forge:stac:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "stac"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual

forge:all:
  extends: .forge_template
  variables:
    CATALOG_TYPE: "all"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual


forge:auto-commit:
  extends: .defaults
  stage: forge
  needs:
    - job: uv:setup
    - job: forge:intake
      optional: true
    - job: forge:stac
      optional: true
    - job: forge:all
      optional: true
  before_script:
    # Install git for auto-commit
    - apt-get update && apt-get install -y git
  script:
    - |
      if [ -f "forge_output/added_to_main.txt" ]; then
        echo "üìù Catalog was added to main catalog, committing changes..."
        git config user.name "gitlab-ci"
        git config user.email "gitlab-ci@${CI_PROJECT_NAMESPACE}.gitlab.com"
        git remote set-url origin https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
        git add catalog/main.yaml
        git commit -m "Add catalog from forge job ${CI_JOB_ID} [skip ci]" || echo "No changes to commit"
        git push origin HEAD:${CI_COMMIT_REF_NAME} || echo "Push failed, but continuing..."
      else
        echo "‚ÑπÔ∏è  No catalog updates to commit"
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"'
      when: on_success
  # Requires CI_PUSH_TOKEN variable with write access

# ============================================================================
# DEPLOY STAGE - GitLab Pages
# ============================================================================

pages:
  extends: .defaults
  stage: deploy
  needs: ["uv:setup"]
  script:
    # Copy entire docs directory to public (contains all pages content)
    - cp -r docs public
    
    # Copy catalog directory (generated by forge jobs)
    - cp -r catalog public/ || echo "No catalog directory found yet"
    
    # Copy README to public root
    - cp README.md public/ || echo "No README.md found"
    
    # Create documentation index page
    - |
      cat > public/documentation.html << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>2catalogs Documentation</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
          <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
          <style>
              body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                  margin: 0;
                  padding: 0;
                  display: flex;
                  min-height: 100vh;
                  background: #f6f8fa;
              }
              .sidebar {
                  width: 280px;
                  background: #24292e;
                  color: white;
                  padding: 20px;
                  overflow-y: auto;
                  position: fixed;
                  height: 100vh;
              }
              .sidebar h2 {
                  color: #58a6ff;
                  font-size: 1.3em;
                  margin: 20px 0 10px 0;
                  border-bottom: 1px solid #444;
                  padding-bottom: 5px;
              }
              .sidebar h2:first-child {
                  margin-top: 0;
              }
              .sidebar ul {
                  list-style: none;
                  padding: 0;
                  margin: 0 0 20px 0;
              }
              .sidebar li {
                  margin: 5px 0;
              }
              .sidebar a {
                  color: #c9d1d9;
                  text-decoration: none;
                  display: block;
                  padding: 5px 10px;
                  border-radius: 5px;
                  transition: background 0.2s;
              }
              .sidebar a:hover {
                  background: #30363d;
                  color: #58a6ff;
              }
              .sidebar a.active {
                  background: #388bfd;
                  color: white;
              }
              .content {
                  margin-left: 280px;
                  flex: 1;
                  padding: 40px;
                  max-width: 1200px;
              }
              .markdown-body {
                  background: white;
                  padding: 40px;
                  border-radius: 8px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              }
              .home-content {
                  background: white;
                  padding: 40px;
                  border-radius: 8px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              }
              .home-content h1 {
                  color: #24292e;
                  border-bottom: 2px solid #58a6ff;
                  padding-bottom: 10px;
              }
              .doc-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                  gap: 20px;
                  margin-top: 30px;
              }
              .doc-card {
                  border: 1px solid #d0d7de;
                  border-radius: 8px;
                  padding: 20px;
                  transition: all 0.2s;
              }
              .doc-card:hover {
                  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                  border-color: #58a6ff;
              }
              .doc-card h3 {
                  color: #24292e;
                  margin-top: 0;
              }
              .doc-card a {
                  color: #0969da;
                  text-decoration: none;
                  font-weight: 600;
              }
              .doc-card a:hover {
                  text-decoration: underline;
              }
              @media (max-width: 768px) {
                  .sidebar {
                      display: none;
                  }
                  .content {
                      margin-left: 0;
                      padding: 20px;
                  }
              }
          </style>
      </head>
      <body>
          <div class="sidebar">
              <h1 style="color: white; font-size: 1.5em; margin-bottom: 20px;">üìö Documentation</h1>
              
              <h2>üè† Main</h2>
              <ul>
                  <li><a href="#" onclick="showHome(); return false;">Home</a></li>
                  <li><a href="/" target="_blank">Catalog Browser</a></li>
                  <li><a href="#README.md" onclick="loadDoc('README.md'); return false;">README</a></li>
              </ul>
              
              <h2>üìò User Guides</h2>
              <ul id="forge-docs"></ul>
              
              <h2>‚öôÔ∏è CI/CD Docs</h2>
              <ul id="ci-docs"></ul>
              
              <h2>üîß GitLab Setup</h2>
              <ul id="gitlab-docs"></ul>
          </div>
          
          <div class="content">
              <div id="home-view" class="home-content">
                  <h1>2catalogs Documentation</h1>
                  <p>Welcome to the 2catalogs documentation. Browse through the guides using the sidebar or explore the sections below.</p>
                  
                  <div class="doc-grid">
                      <div class="doc-card">
                          <h3>üöÄ Quick Start</h3>
                          <p>Get started with catalog generation using the Forge system.</p>
                          <a href="#docs/FORGE_QUICKSTART.md" onclick="loadDoc('docs/FORGE_QUICKSTART.md'); return false;">Read Guide ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h3>üìñ Forge Guide</h3>
                          <p>Complete guide to using the catalog generation system.</p>
                          <a href="#docs/FORGE.md" onclick="loadDoc('docs/FORGE.md'); return false;">Read Guide ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h3>üèóÔ∏è Architecture</h3>
                          <p>Understand the CI/CD pipeline architecture and design.</p>
                          <a href="#ci/CI_ARCHITECTURE.md" onclick="loadDoc('ci/CI_ARCHITECTURE.md'); return false;">View Architecture ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h3>üì¶ UV Migration</h3>
                          <p>Learn about the modern UV-based CI/CD setup.</p>
                          <a href="#ci/gitlab/UV_MIGRATION_GUIDE.md" onclick="loadDoc('ci/gitlab/UV_MIGRATION_GUIDE.md'); return false;">Migration Guide ‚Üí</a>
                      </div>
                  </div>
              </div>
              
              <div id="markdown-content" class="markdown-body" style="display: none;"></div>
          </div>
          
          <script>
              // Document lists
              const forgeDocs = [
                  'FORGE.md', 'FORGE_QUICKSTART.md', 'FORGE_ARCHITECTURE.md', 
                  'FORGE_EXAMPLES.md', 'FORGE_CHECKLIST.md', 'FORGE_SUMMARY.md',
                  'COMMUNITY_CATALOG.md'
              ];
              
              const ciDocs = [
                  'CI_ARCHITECTURE.md', 'CI_SPLIT_GUIDE.md', 'CI_SPLIT_SUMMARY.md'
              ];
              
              const gitlabDocs = [
                  'UV_MIGRATION_GUIDE.md', 'README.md'
              ];
              
              // Populate sidebar
              function populateSidebar() {
                  const forgeList = document.getElementById('forge-docs');
                  const ciList = document.getElementById('ci-docs');
                  const gitlabList = document.getElementById('gitlab-docs');
                  
                  forgeDocs.forEach(doc => {
                      const li = document.createElement('li');
                      const a = document.createElement('a');
                      a.href = '#docs/' + doc;
                      a.textContent = doc.replace('.md', '').replace(/_/g, ' ');
                      a.onclick = (e) => { e.preventDefault(); loadDoc('docs/' + doc); };
                      li.appendChild(a);
                      forgeList.appendChild(li);
                  });
                  
                  ciDocs.forEach(doc => {
                      const li = document.createElement('li');
                      const a = document.createElement('a');
                      a.href = '#ci/' + doc;
                      a.textContent = doc.replace('.md', '').replace(/_/g, ' ');
                      a.onclick = (e) => { e.preventDefault(); loadDoc('ci/' + doc); };
                      li.appendChild(a);
                      ciList.appendChild(li);
                  });
                  
                  gitlabDocs.forEach(doc => {
                      const li = document.createElement('li');
                      const a = document.createElement('a');
                      a.href = '#ci/gitlab/' + doc;
                      a.textContent = doc.replace('.md', '').replace(/_/g, ' ');
                      a.onclick = (e) => { e.preventDefault(); loadDoc('ci/gitlab/' + doc); };
                      li.appendChild(a);
                      gitlabList.appendChild(li);
                  });
              }
              
              // Load markdown document
              async function loadDoc(path) {
                  const homeView = document.getElementById('home-view');
                  const contentDiv = document.getElementById('markdown-content');
                  
                  homeView.style.display = 'none';
                  contentDiv.style.display = 'block';
                  contentDiv.innerHTML = '<p>Loading...</p>';
                  
                  try {
                      const response = await fetch(path);
                      if (!response.ok) throw new Error('Document not found');
                      
                      const markdown = await response.text();
                      contentDiv.innerHTML = marked.parse(markdown);
                      
                      // Update active link
                      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
                      document.querySelector(`a[href="#${path}"]`)?.classList.add('active');
                      
                      // Scroll to top
                      window.scrollTo(0, 0);
                  } catch (error) {
                      contentDiv.innerHTML = `<p>Error loading document: ${error.message}</p>`;
                  }
              }
              
              // Show home view
              function showHome() {
                  document.getElementById('home-view').style.display = 'block';
                  document.getElementById('markdown-content').style.display = 'none';
                  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
                  document.querySelector('.sidebar a[href="#"]')?.classList.add('active');
              }
              
              // Initialize
              populateSidebar();
              
              // Handle initial hash
              if (window.location.hash) {
                  const path = window.location.hash.substring(1);
                  loadDoc(path);
              }
          </script>
      </body>
      </html>
      EOF
    
    - echo "‚úì Deployed to GitLab Pages with documentation"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == $PAGES_BRANCH'
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab-pages.dkrz.de/-/$CI_PROJECT_NAME/
  # For GitLab Pages, artifacts must be in 'public' directory
