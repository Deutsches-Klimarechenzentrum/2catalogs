name: Restart Failed Forge Catalog Issues

on:
  push:
    branches:
      - main

jobs:
  restart-failed-issues:
    name: Restart Failed Forge Catalog Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: write
    steps:
      - name: List issues with 'forge-failed' label
        id: list-failed
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'forge-failed',
                per_page: 100
              }
            );
            core.setOutput('issue_numbers', issues.map(i => i.number).join(','));

      - name: Re-run forge-catalog workflow for failed issues
        if: steps.list-failed.outputs.issue_numbers != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumbers = process.env.ISSUE_NUMBERS || '';
            if (!issueNumbers) return;
            for (const num of issueNumbers.split(',')) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'forge-catalog.yml',
                ref: 'main',
                inputs: {
                  issue_number: num
                }
              });
            }
        env:
          ISSUE_NUMBERS: ${{ steps.list-failed.outputs.issue_numbers }}
