name: Forge Catalog (DISABLED - Use GitLab)

# ============================================================================
# THIS WORKFLOW IS DISABLED
# ============================================================================
# Catalog generation (Forge) has been moved to GitLab CI/CD
# Issue-based forge automation now runs on GitLab
# 
# To use the forge system:
# 1. Create issues on GitLab with forge templates
# 2. Or trigger manual pipeline runs in GitLab CI/CD
#
# GitHub Actions now handles only testing and basic CI
# ============================================================================

on:
  # Disabled: issues trigger moved to GitLab
  # issues:
  #   types: [opened]
  
  # This workflow is now disabled
  workflow_dispatch:
    inputs:
      note:
        description: 'This workflow is disabled. Use GitLab for forge operations.'
        required: false

permissions:
  issues: write
  contents: write

jobs:
  disabled-notice:
    name: Forge Has Moved to GitLab
    runs-on: ubuntu-latest
    if: false  # Always skip this workflow
    steps:
      - name: Notice
        run: |
          echo "============================================"
          echo "Forge workflow has been moved to GitLab CI"
          echo "============================================"
          echo ""
          echo "To generate catalogs:"
          echo "1. Go to GitLab repository"
          echo "2. Create an issue using forge templates"
          echo "3. Or run manual pipeline in CI/CD > Pipelines"
          echo ""
          echo "GitHub Actions now handles:"
          echo "- Testing on multiple Python versions"
          echo "- Linting and code quality"
          echo "- Building packages"
          echo ""
          echo "GitLab CI/CD now handles:"
          echo "- Catalog generation (forge)"
          echo "- GitLab Pages deployment"
          echo "- Issue-based automation"
    
    steps:
      - name: Debug issue information
        run: |
          echo "=== Issue Debug Information ==="
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue title: ${{ github.event.issue.title }}"
          echo "Issue state: ${{ github.event.issue.state }}"
          echo "Event action: ${{ github.event.action }}"
          echo "Labels: ${{ toJSON(github.event.issue.labels.*.name) }}"
          echo "Has forge-intake: ${{ contains(github.event.issue.labels.*.name, 'forge-intake') }}"
          echo "Has forge-stac: ${{ contains(github.event.issue.labels.*.name, 'forge-stac') }}"
          echo "=============================="

      - name: Comment workflow started
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `üöÄ **Catalog generation started!**\n\n` +
              `The forge pipeline is now processing your request.\n\n` +
              `**Status:** Running\n` +
              `**Workflow:** [View live progress](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n` +
              `You will be notified here when the generation is complete.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Determine catalog type
        id: catalog-type
        run: |
          HAS_INTAKE=${{ contains(github.event.issue.labels.*.name, 'forge-intake') }}
          HAS_STAC=${{ contains(github.event.issue.labels.*.name, 'forge-stac') }}
          TITLE="${{ github.event.issue.title }}"
          
          echo "Determining catalog type..."
          echo "Title: $TITLE"
          echo "Has forge-intake label: $HAS_INTAKE"
          echo "Has forge-stac label: $HAS_STAC"
          
          # Check labels first, then fall back to title
          if [ "$HAS_INTAKE" = "true" ] && [ "$HAS_STAC" = "true" ]; then
            echo "type=all" >> $GITHUB_OUTPUT
            echo "extras=intake,stac" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: ALL (Intake + STAC)"
          elif [ "$HAS_INTAKE" = "true" ] || [[ "$TITLE" == *"[Forge-Intake]"* ]]; then
            echo "type=intake" >> $GITHUB_OUTPUT
            echo "extras=intake" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: INTAKE"
          elif [ "$HAS_STAC" = "true" ] || [[ "$TITLE" == *"[Forge-STAC]"* ]]; then
            echo "type=stac" >> $GITHUB_OUTPUT
            echo "extras=stac" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: STAC"
          elif [[ "$TITLE" == *"[Forge-All]"* ]]; then
            echo "type=all" >> $GITHUB_OUTPUT
            echo "extras=intake,stac" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: ALL (from title)"
          else
            echo "‚ùå Could not determine catalog type"
            exit 1
          fi

      - name: Install dependencies
        run: |
          pip install -e ".[${{ steps.catalog-type.outputs.extras }}]"

      - name: Parse issue and generate catalog
        id: forge
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CATALOG_TYPE: ${{ steps.catalog-type.outputs.type }}
        run: |
          set -e
          pip install pyyaml
          python .github/scripts/forge_parser.py

      - name: Commit and push catalog updates
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "forge_output/added_to_main.txt" ]; then
            echo "üìù Catalog was added to main catalog, committing changes..."
            git add catalog/main.yaml
            git commit -m "Add catalog from issue #${{ github.event.issue.number }}" || echo "No changes to commit"
            git push || echo "Push failed, but continuing..."
          else
            echo "‚ÑπÔ∏è  No catalog updates to commit"
          fi

      - name: Check for duplicate warning
        id: duplicate-check
        if: always()
        run: |
          if [ -f "forge_output/duplicate_warning.txt" ]; then
            echo "has_duplicate=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Duplicate warning found"
          else
            echo "has_duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload generated catalog
        uses: actions/upload-artifact@v4
        with:
          name: catalog-issue-${{ github.event.issue.number }}
          path: forge_output/
          retention-days: 90

      - name: Comment on issue with success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '‚úÖ **Catalog generation completed successfully!**\n\n';
            
            // Check for duplicate warning
            if (fs.existsSync('forge_output/duplicate_warning.txt')) {
              const warning = fs.readFileSync('forge_output/duplicate_warning.txt', 'utf8');
              comment += warning + '\n\n';
              comment += '---\n\n';
            }
            
            // Check if added to main catalog
            if (fs.existsSync('forge_output/added_to_main.txt')) {
              const addedMsg = fs.readFileSync('forge_output/added_to_main.txt', 'utf8');
              comment += 'üéâ ' + addedMsg + '\n\n';
              comment += `Your catalog is now available in the [community catalog](${context.payload.repository.html_url.replace('github.com', 'github.io').replace(/\/[^\/]+$/, '')})!\n\n`;
              comment += '---\n\n';
            }
            
            // Read the output info file if it exists
            if (fs.existsSync('forge_output/info.txt')) {
              const info = fs.readFileSync('forge_output/info.txt', 'utf8');
              comment += '**Details:**\n```\n' + info + '\n```\n\n';
            }
            
            comment += '**Download the generated catalog:**\n';
            comment += `- Go to the [Actions tab](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            comment += `- Download the artifact: \`catalog-issue-${context.issue.number}\`\n\n`;
            comment += '**Artifact retention:** 90 days\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on issue with failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '‚ùå **Catalog generation failed!**\n\n';
            
            // Try to read error log if it exists
            if (fs.existsSync('forge_output/error.log')) {
              const error = fs.readFileSync('forge_output/error.log', 'utf8');
              comment += '**Error details:**\n```\n' + error + '\n```\n\n';
            }
            
            comment += 'Please check:\n';
            comment += '- The input URI is valid and accessible\n';
            comment += '- The issue body follows the template format\n';
            comment += '- The input catalog format is supported\n\n';
            comment += `See the [full logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for more details.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Add status label
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ job.status }}' === 'success' ? 'forge-complete' : 'forge-failed';
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [label]
            });
