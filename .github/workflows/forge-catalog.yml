name: Forge Catalog

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  parse-and-forge:
    name: Parse Issue and Generate Catalog
    if: |
      github.event.issue.state == 'open' &&
      (contains(github.event.issue.labels.*.name, 'forge-intake') ||
       contains(github.event.issue.labels.*.name, 'forge-stac') ||
       startsWith(github.event.issue.title, '[Forge-Intake]') ||
       startsWith(github.event.issue.title, '[Forge-STAC]') ||
       startsWith(github.event.issue.title, '[Forge-All]'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug issue information
        run: |
          echo "=== Issue Debug Information ==="
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue title: ${{ github.event.issue.title }}"
          echo "Issue state: ${{ github.event.issue.state }}"
          echo "Event action: ${{ github.event.action }}"
          echo "Labels: ${{ toJSON(github.event.issue.labels.*.name) }}"
          echo "Has forge-intake: ${{ contains(github.event.issue.labels.*.name, 'forge-intake') }}"
          echo "Has forge-stac: ${{ contains(github.event.issue.labels.*.name, 'forge-stac') }}"
          echo "=============================="

      - name: Comment workflow started
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `üöÄ **Catalog generation started!**\n\n` +
              `The forge pipeline is now processing your request.\n\n` +
              `**Status:** Running\n` +
              `**Workflow:** [View live progress](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n` +
              `You will be notified here when the generation is complete.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Determine catalog type
        id: catalog-type
        run: |
          HAS_INTAKE=${{ contains(github.event.issue.labels.*.name, 'forge-intake') }}
          HAS_STAC=${{ contains(github.event.issue.labels.*.name, 'forge-stac') }}
          TITLE="${{ github.event.issue.title }}"
          
          echo "Determining catalog type..."
          echo "Title: $TITLE"
          echo "Has forge-intake label: $HAS_INTAKE"
          echo "Has forge-stac label: $HAS_STAC"
          
          # Check labels first, then fall back to title
          if [ "$HAS_INTAKE" = "true" ] && [ "$HAS_STAC" = "true" ]; then
            echo "type=all" >> $GITHUB_OUTPUT
            echo "extras=intake,stac" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: ALL (Intake + STAC)"
          elif [ "$HAS_INTAKE" = "true" ] || [[ "$TITLE" == *"[Forge-Intake]"* ]]; then
            echo "type=intake" >> $GITHUB_OUTPUT
            echo "extras=intake" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: INTAKE"
          elif [ "$HAS_STAC" = "true" ] || [[ "$TITLE" == *"[Forge-STAC]"* ]]; then
            echo "type=stac" >> $GITHUB_OUTPUT
            echo "extras=stac" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: STAC"
          elif [[ "$TITLE" == *"[Forge-All]"* ]]; then
            echo "type=all" >> $GITHUB_OUTPUT
            echo "extras=intake,stac" >> $GITHUB_OUTPUT
            echo "‚úì Catalog type: ALL (from title)"
          else
            echo "‚ùå Could not determine catalog type"
            exit 1
          fi

      - name: Install dependencies
        run: |
          pip install -e ".[${{ steps.catalog-type.outputs.extras }}]"

      - name: Parse issue and generate catalog
        id: forge
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CATALOG_TYPE: ${{ steps.catalog-type.outputs.type }}
        run: |
          python .github/scripts/forge_parser.py

      - name: Upload generated catalog
        uses: actions/upload-artifact@v4
        with:
          name: catalog-issue-${{ github.event.issue.number }}
          path: forge_output/
          retention-days: 90

      - name: Comment on issue with success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '‚úÖ **Catalog generation completed successfully!**\n\n';
            
            // Read the output info file if it exists
            if (fs.existsSync('forge_output/info.txt')) {
              const info = fs.readFileSync('forge_output/info.txt', 'utf8');
              comment += '**Details:**\n```\n' + info + '\n```\n\n';
            }
            
            comment += '**Download the generated catalog:**\n';
            comment += `- Go to the [Actions tab](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            comment += `- Download the artifact: \`catalog-issue-${context.issue.number}\`\n\n`;
            comment += '**Artifact retention:** 90 days\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on issue with failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '‚ùå **Catalog generation failed!**\n\n';
            
            // Try to read error log if it exists
            if (fs.existsSync('forge_output/error.log')) {
              const error = fs.readFileSync('forge_output/error.log', 'utf8');
              comment += '**Error details:**\n```\n' + error + '\n```\n\n';
            }
            
            comment += 'Please check:\n';
            comment += '- The input URI is valid and accessible\n';
            comment += '- The issue body follows the template format\n';
            comment += '- The input catalog format is supported\n\n';
            comment += `See the [full logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for more details.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Add status label
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ job.status }}' === 'success' ? 'forge-complete' : 'forge-failed';
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [label]
            });
