name: Trigger GitLab CI for Forge

# ============================================================================
# GitHub Workflow to Trigger GitLab CI
# ============================================================================
# This workflow triggers GitLab CI/CD pipeline when issues are created with
# forge labels. The actual catalog generation runs on GitLab runners.
#
# Prerequisites:
# - GITLAB_TRIGGER_TOKEN: GitLab pipeline trigger token (set in GitHub secrets)
# - GITLAB_PROJECT_ID: GitLab project ID (set in GitHub secrets)
# ============================================================================

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  check-and-trigger:
    name: Check Issue and Trigger GitLab
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for forge labels
        id: check-labels
        run: |
          LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
          echo "Labels found: $LABELS"
          
          if echo "$LABELS" | grep -qE '"forge-(intake|stac|all)"'; then
            echo "has_forge_label=true" >> $GITHUB_OUTPUT
            echo "‚úì Issue has forge label"
          else
            echo "has_forge_label=false" >> $GITHUB_OUTPUT
            echo "‚úó Issue does not have forge label"
          fi
      
      - name: Comment on missing labels
        if: steps.check-labels.outputs.has_forge_label == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `‚ÑπÔ∏è **No forge label detected**\n\n` +
              `To trigger catalog generation, please add one of these labels:\n` +
              `- \`forge-intake\` - Generate Intake catalog\n` +
              `- \`forge-stac\` - Generate STAC catalog\n` +
              `- \`forge-all\` - Generate both catalogs\n\n` +
              `The GitLab CI pipeline will be triggered automatically once a forge label is added.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Determine catalog type
        id: catalog-type
        if: steps.check-labels.outputs.has_forge_label == 'true'
        run: |
          LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
          
          if echo "$LABELS" | grep -q "forge-all"; then
            echo "type=all" >> $GITHUB_OUTPUT
            echo "job=forge:all" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "forge-stac"; then
            echo "type=stac" >> $GITHUB_OUTPUT
            echo "job=forge:stac" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "forge-intake"; then
            echo "type=intake" >> $GITHUB_OUTPUT
            echo "job=forge:intake" >> $GITHUB_OUTPUT
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
            echo "job=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Comment workflow started
        if: steps.check-labels.outputs.has_forge_label == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const catalogType = '${{ steps.catalog-type.outputs.type }}';
            const comment = `üöÄ **Catalog generation started!**\n\n` +
              `The forge pipeline is now being triggered on GitLab CI.\n\n` +
              `**Catalog Type:** ${catalogType}\n` +
              `**Status:** Triggering GitLab pipeline...\n\n` +
              `You will be notified here when the generation is complete.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Trigger GitLab CI Pipeline
        if: steps.check-labels.outputs.has_forge_label == 'true'
        env:
          GITLAB_TRIGGER_TOKEN: ${{ secrets.GITLAB_TRIGGER_TOKEN }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
          GITLAB_HOST: ${{ secrets.GITLAB_HOST || 'gitlab.com' }}
        run: |
          # Prepare issue body (escape for JSON)
          ISSUE_BODY=$(cat <<'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
          
          # Trigger GitLab pipeline with issue context
          RESPONSE=$(curl -X POST \
            "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/trigger/pipeline" \
            -F "token=${GITLAB_TRIGGER_TOKEN}" \
            -F "ref=main" \
            -F "variables[GITHUB_ISSUE_NUMBER]=${{ github.event.issue.number }}" \
            -F "variables[GITHUB_ISSUE_TITLE]=${{ github.event.issue.title }}" \
            -F "variables[GITHUB_ISSUE_BODY]=${ISSUE_BODY}" \
            -F "variables[GITHUB_ISSUE_LABELS]=${{ join(github.event.issue.labels.*.name, ',') }}" \
            -F "variables[CATALOG_TYPE]=${{ steps.catalog-type.outputs.type }}" \
            -F "variables[FORGE_JOB]=${{ steps.catalog-type.outputs.job }}" \
            -F "variables[GITHUB_TOKEN]=${{ secrets.GITHUB_TOKEN }}" \
            -F "variables[GITHUB_REPOSITORY]=${{ github.repository }}")
            -F "variables[GITHUB_TOKEN]=${{ secrets.GITHUB_TOKEN }}" \
            -F "variables[GITHUB_REPOSITORY]=${{ github.repository }}")
          
          echo "GitLab API Response:"
          echo "$RESPONSE" | jq '.'
          
          PIPELINE_ID=$(echo "$RESPONSE" | jq -r '.id')
          PIPELINE_URL=$(echo "$RESPONSE" | jq -r '.web_url')
          
          if [ "$PIPELINE_ID" != "null" ] && [ -n "$PIPELINE_ID" ]; then
            echo "‚úì Pipeline triggered successfully: $PIPELINE_URL"
            echo "pipeline_id=$PIPELINE_ID" >> $GITHUB_OUTPUT
            echo "pipeline_url=$PIPELINE_URL" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to trigger pipeline"
            exit 1
          fi
        id: trigger

      - name: Comment pipeline link
        uses: actions/github-script@v7
        if: success() && steps.check-labels.outputs.has_forge_label == 'true'
        with:
          script: |
            const pipelineUrl = '${{ steps.trigger.outputs.pipeline_url }}';
            const comment = `‚úì GitLab pipeline triggered successfully!\n\n` +
              `**Pipeline:** [View on GitLab](${pipelineUrl})\n\n` +
              `The catalog will be generated on GitLab CI runners.\n\n` +
              `Once complete, a merge request will be created in GitLab for review. ` +
              `You will be notified here with the merge request link.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on failure
        uses: actions/github-script@v7
        if: failure() && steps.check-labels.outputs.has_forge_label == 'true'
        with:
          script: |
            const comment = `‚ùå **Failed to trigger GitLab pipeline**\n\n` +
              `There was an error triggering the GitLab CI/CD pipeline.\n` +
              `Please check the workflow logs or contact the maintainers.\n\n` +
              `[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
